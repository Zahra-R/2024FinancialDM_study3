{% extends "global/Page.html" %}
{% load otree static %}




{% block styles %}
<style type="text/css">

.otree-body {
    max-width: 1370px;
}


table {
    display: inline-table;
    width: 150px;
   /*  border-style: none solid none solid;
    border-width: 5px;
    border-color: black; */
}

table th, td {
    padding: 7px 0;
    line-height: 1.1;
}

.roww {
    display: flex;
    gap: 30px;
    justify-content: center;
}

.singlerow {
    height: 60.8px;
}


    .stimulus {
        border: 3px solid #000;
        text-align: center;
        margin: auto;
        padding: 2vh 0vw;
        vertical-align: middle;
        width: 320px;
    }

    .chosen-stimulus {
        border-color: #228B22;
    }
</style>

{% endblock %}

{% block content %}
<p style="text-align: center; font-size: 0.9rem;">
    Round number <span id ="block_round_number" > </span> out of <span id="block_round_total"> </span>
    <!-- <progress id="myprogress" max="100" ></progress> -->
</p>
<p id="headerspan" style="font-size:200%;text-align:center;"> Please choose one of the options:</p>

<div class="mycont">

<div class="roww">
    <div class="OptionA">
       <div class="col-6 stimulus">
        <div id="left-stimulus">
            <table id="moneyTable_OptA" style="margin-top:30px;">
                {{if RiskyOpt == "A" and RiskyAtt == "Money" }}
                <tbody>
                    <tr class="leftsidetable" style=" font-weight: bold; background-color: grey; color: white;">
                        <th colspan = "2"> Monetary <br> Bonus </th>
                    </tr>
                    <tr>
                        <td> {{player.probA1 | to0 }}%</td>
                        <td> {{moneyA1}}$</td>
                    </tr>
                    <tr class="row-secondary-outcomeA">
                        <td> {{player.probA2 | to0 }}%</td>
                        <td> {{moneyA2 | to0 }}$</td>
                    </tr>
                </tbody>
                {{else}}
                <tbody>
                    <tr class="leftsidetable" style=" font-weight: bold; background-color: grey; color: white;">
                        <th> Monetary <br> Bonus </th>
                    </tr>
                    <tr class="singlerow">
                        <td> {{moneyA | to0 }}$</td>
                    </tr>
                    
                </tbody>
                {{endif}}
            </table>

            <table id="carbonTable_OptA" style="margin-top: 30px;">
                {{if RiskyOpt == "A" and RiskyAtt == "CO2" }}
                    <tbody>
                        <tr class="leftsidetable" style=" font-weight: bold; background-color: grey; color: white;">
                            <th colspan = "2"> Carbon <br> Emissions </th>
                        </tr>
                        <tr>
                            <td> {{player.probA1 | to0 }}%</td>
                            <td> {{carbonA1 | to0}}lbs. CO2</td>
                        </tr>
                        <tr class="row-secondary-outcomeA">
                            <td> {{player.probA2 | to0 }}%</td>
                            <td> {{carbonA2 | to0}}lbs. CO2</td>
                        </tr>
                    </tbody>
                {{else}}
                <tbody>
                    <tr class="leftsidetable" style=" font-weight: bold; background-color: grey; color: white;">
                        <th> Carbon <br> Emissions</th>
                    </tr>
                    <tr class="singlerow">
                        <td> {{carbonA | to0}}lbs. CO2</td>
                    </tr>
                    
                </tbody>
                {{endif}}

            </table>
        </div>


        <p style="margin-top: 30px;"> Press <i>f</i> for left option </p>

       </div>
      
    </div>


    <div class="OptionB">
        <div class="col-6 stimulus">
            <div id="right-stimulus">
                <table id="moneyTable_OptB" style="margin-top:30px;">
                    {{if RiskyOpt == "B" and RiskyAtt == "Money" }}
                    <tbody>
                        <tr id="rightsidetable" style=" font-weight: bold; background-color: grey; color: white;">
                            <th colspan = "2"> Monetary <br> Bonus</th>
                        </tr>
                        <tr>
                            <td> {{player.probB1 | to0 }}%</td>
                            <td> {{moneyB1| to0 }}$</td>
                        </tr>
                        <tr class="row-secondary-outcomeA">
                            <td> {{player.probB2 | to0 }}%</td>
                            <td> {{moneyB2| to0 }}$</td>
                        </tr>
                    </tbody>
                    {{else}}
                    <tbody>
                        <tr class="rightsidetable" style=" font-weight: bold; background-color: grey; color: white;">
                            <th> Monetary <br> Bonus</th>
                        </tr>
                        <tr class="singlerow">
                            <td> {{moneyB | to0 }}$</td>
                        </tr>
                        
                    </tbody>
                    {{endif}}
                </table>
    
                <table id="carbonTable_OptB" style="margin-top: 30px;">
                    {{if RiskyOpt == "B" and RiskyAtt == "CO2" }}
                    <tbody>
                        <tr id="rightsidetable" style=" font-weight: bold; background-color: grey; color: white;">
                            <th colspan = "2"> Carbon <br> Emissions </th>
                        </tr>
                        <tr>
                            <td> {{player.probB1 | to0 }}% </td>
                            <td> {{carbonB1 | to0}}lbs. CO2</td>
                        </tr>
                        <tr class="row-secondary-outcomeA">
                            <td> {{player.probB2 | to0 }}% </td>
                            <td> {{carbonB2 | to0 }}lbs. CO2</td>
                        </tr>
                    </tbody>
                    {{else}}
                    <tbody>
                        <tr class="rightsidetable" style=" font-weight: bold; background-color: grey; color: white;">
                            <th> Carbon <br> Emissions </th>
                        </tr>
                        <tr class="singlerow">
                            <td> {{carbonB | to0}}lbs. CO2</td>
                        </tr>
                        
                    </tbody>
                    {{endif}}
    
                </table>
            </div>
    
    
            <p style="margin-top: 30px;"> Press <i>j</i> for right option </p>
    
           </div>

     </div>
</div>
</div>

<p style="float:right; margin-right: 61px; margin-top: 30px;"> Information: 1 lbs CO2 equals ~ 1.1 miles car drive </p>

<p style="text-align:center;"> <button style="display: none;"
        class="otree-btn-next btn btn-primary next-button otree-next-button">next</button> </p>

<input type="hidden" name="choice" />

<input id="input_keyboard" type="hidden" name="input_keyboard" value="0" />



<!-- Modal -->
<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Release keyboard buttons to progress</h5>
                </button>
            </div>
            <div class="modal-body">
                Please release all the keys on your keyboard to progress to the next page of the experiment.
            </div>
        </div>
    </div>
</div>



<input id="page_load" type="hidden" name="page_load" value={{player.page_load}} />
<input id="page_submit" type="hidden" name="page_submit" />
<input id="responsetime" type="hidden" name="responsetime" />

{{ formfield_errors 'page_load' }}
{{ formfield_errors 'responsetime' }}
{{ formfield_errors 'page_submit' }}
{{ formfield_errors 'choice' }}
{{ formfield_errors 'input_keyboard' }}


{% endblock %}

{% block scripts %}
<script type="text/javascript">
    jQuery('.otree-btn-next').hide()


    var keys = new Set();

    var choiceListener

    var reverse = "{{reverse}}"
    var AoutcomeOneTop = "{{AoutcomeOneTop}}"
    var BoutcomeOneTop = "{{BoutcomeOneTop}}"
    var page_load = "{{player.page_load}}"
    var progress_total = "{{C.NUM_ROUNDS}}"
    var round_num = "{{game_round}}"
    var practice = "{{practice}}"
    var subtract_practice = "{{subtract_practice}}"
    var carbonLeft = "{{carbonLeft}}"
    //var progress = 100*(round_num / progress_total)


    choiceListener = {

        KEY_F: 0,
        KEYDOWN_F: 0,
        KEY_J: 0,
        KEYDOWN_J: 0,

        init() {

            jQuery(document).on('keydown', choiceListener.keyboardInput);

            // no mouseinputs allowed
            //jQuery('#left-stimulus').on('click', choiceListener.AClick);

            //jQuery('#right-stimulus').on('click',choiceListener.BClick);

        },

        AClick() {
            disable_inputs();
            var submit_timestamp = Date.now()
            var load_timestamp =  jQuery('#page_load').val();
            jQuery('#responsetime').val(submit_timestamp - load_timestamp);
            jQuery('#page_submit').val(String(submit_timestamp));
            jQuery('.chosen-stimulus').removeClass('chosen-stimulus');
            jQuery('[name="choice"]').val("A");
            //jQuery('#left-stimulus').addClass('chosen-stimulus');
            jQuery('#left-stimulus')[0].parentElement.classList.add("chosen-stimulus")
            setTimeout(progress_experiment, 500)
        },

        BClick() {
            disable_inputs();
            var submit_timestamp = Date.now()
            var load_timestamp =  jQuery('#page_load').val();
            jQuery('#responsetime').val(submit_timestamp - load_timestamp);
            jQuery('#page_submit').val(String(submit_timestamp));
            jQuery('.chosen-stimulus').removeClass('chosen-stimulus');
            jQuery('[name="choice"]').val("B");
            jQuery('#right-stimulus')[0].parentElement.classList.add("chosen-stimulus")
            //jQuery('#right-stimulus').addClass('chosen-stimulus');
            setTimeout(progress_experiment, 500)

        },

        keyboardInput(event) {


            if (event.which == choiceListener.KEY_F || event.which == choiceListener.KEYDOWN_F) {
                jQuery('[name="input_keyboard"]').val(1);
                choiceListener.AClick();
                disable_inputs();

            }
            if (event.which == choiceListener.KEY_J || event.which == choiceListener.KEYDOWN_J) {
                jQuery('[name="input_keyboard"]').val(1);
                choiceListener.BClick();
                disable_inputs();
            }
        }

    }


    function disable_inputs() {
        jQuery('#right-stimulus').off('click');
        jQuery('#left-stimulus').off('click');
        jQuery(document).off('keydown');
        jQuery(document).on('keydown', function (event) {
            keys.add(event.which);
        });
    }

    function switchOutcomeRowsOptionA() {
        jQuery(".row-secondary-outcomeA").prev().before(jQuery(".row-secondary-outcomeA"));
    }

    function switchOutcomeRowsOptionB() {
        jQuery(".row-secondary-outcomeB").prev().before(jQuery(".row-secondary-outcomeB"));
    }



    function switchSides() {
        div1 = $('#left-stimulus');
        div2 = $('#right-stimulus');

        tdiv1 = div1.clone();
        tdiv2 = div2.clone();

        div1.replaceWith(tdiv2);
        div2.replaceWith(tdiv1);

        choiceListener.init();
        //jQuery(document).on('keydown', console.log("now"), console.log(""), choiceListener.keyboardInput);
        //jQuery('#left-stimulus').on('click', choiceListener.AClick());
        //jQuery('#right-stimulus').on('click', choiceListener.BClick());
    }


    function switchCarbonLeft() {
        div1 = $('#moneyTable_OptA');
        div2 = $('#carbonTable_OptA');

        tdiv1 = div1.clone(true);
        tdiv2 = div2.clone(true);

        div1.replaceWith(tdiv2);
        div2.replaceWith(tdiv1);


        div3 = $('#moneyTable_OptB');
        div4 = $('#carbonTable_OptB');

        tdiv3 = div3.clone(true);
        tdiv4 = div4.clone(true);

        div3.replaceWith(tdiv4);
        div4.replaceWith(tdiv3);

        choiceListener.init();
        //jQuery(document).on('keydown', console.log("now"), console.log(""), choiceListener.keyboardInput);
        //jQuery('#left-stimulus').on('click', choiceListener.AClick());
        //jQuery('#right-stimulus').on('click', choiceListener.BClick());
    }

    function progress_experiment() {
        if (keys.size > 0) {
            $('#modal').modal('show');

            jQuery(document).off('keyup').on('keyup', function (event) {
                keys.delete(event.which);

                if (keys.size == 0) {
                    jQuery('.otree-btn-next').click();
                }

            });
        }
        else {
            jQuery('.otree-btn-next').click()
        }
    }

    jQuery(document).on('keyup', function (event) {
        keys.delete(event.which);
    });

    jQuery(document).on('keydown', function (event) {
        keys.add(event.which);
    });


    jQuery(document).ready(function () {

        if (page_load == '0') {
            var load_timestamp = Date.now()
            jQuery('#page_load').val(String(load_timestamp));
        }

        if ( AoutcomeOneTop == "False"){
            switchOutcomeRowsOptionA()
        }
        if ( BoutcomeOneTop == "False"){
            switchOutcomeRowsOptionB()
        }

        if (carbonLeft == "True") {
            switchCarbonLeft()
        }

        if (reverse == 1) {
            switchSides()
            choiceListener.KEY_J = 102
            choiceListener.KEY_F = 106
            choiceListener.KEYDOWN_J = 70
            choiceListener.KEYDOWN_F = 74
        }

        if (reverse == 0) {
            choiceListener.KEY_F = 102
            choiceListener.KEY_J = 106
            choiceListener.KEYDOWN_F = 70
            choiceListener.KEYDOWN_J = 74
        }

        block_round = parseInt(round_num)
        subtract_practice = parseInt(subtract_practice)
        if (practice == "True") {
            $("#headerspan").prepend("This is a practice round: ")
            $("#block_round_number").html((block_round -13)%86)
            $("#block_round_total").html("2 in this practice block.")
        }
        else {
            $("#block_round_number").html((block_round - subtract_practice)%84 +1 )
            $("#block_round_total").html("84 in this block. ")
        }

        choiceListener.init();

    });

</script>
{% endblock %}